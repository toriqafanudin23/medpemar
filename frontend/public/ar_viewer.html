<!DOCTYPE html>
<html>
  <head>
    <title>AR Viewer</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <!-- AR.js for A-Frame -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <!-- A-Frame Extras for Animation Mixer -->
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.4.0/dist/aframe-extras.min.js"></script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family: sans-serif;
      }
      #loading {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      /* Control Panel Styles */
      #controls {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 12px;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.8);
        padding: 10px;
        border-radius: 20px;
        backdrop-filter: blur(5px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      }
      
      /* Fullscreen Button - Top Left */
      #fullscreen-btn {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 1000;
      }
      
      .btn {
        width: 44px;
        height: 44px;
        border: none;
        border-radius: 50%;
        background: white;
        color: #333;
        font-size: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.2s ease;
      }
      
      .btn:active {
        transform: scale(0.95);
        background: #f0f0f0;
      }
      
      .btn.active {
        background: #3498db;
        color: white;
      }
      
      .btn svg {
        width: 24px;
        height: 24px;
        fill: none;
        stroke: currentColor;
        stroke-width: 2;
        stroke-linecap: round;
        stroke-linejoin: round;
      }
    </style>
  </head>
  <body>
    <div id="loading">
      <div style="text-align: center">
        <div class="loader" style="margin: 0 auto 10px"></div>
        <div>Memuat AR...</div>
      </div>
    </div>

    <!-- UI Controls -->
    <div id="controls">
      <button class="btn" id="btn-zoom-out" onclick="zoomOut()">
        <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
      </button>
      <button class="btn" id="btn-zoom-in" onclick="zoomIn()">
        <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
      </button>
      <div style="width: 1px; background: #ccc; margin: 0 4px;"></div>
      <button class="btn" id="btn-anim" onclick="toggleAnimation()">
        <svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
      </button>
    </div>

    <script>
      // Parse query parameters
      const urlParams = new URLSearchParams(window.location.search);
      const modelUrl = urlParams.get("model");
      // Default to smaller scale (0.3) as requested
      let currentScale = parseFloat(urlParams.get("scale")) || 0.15;
      if (isNaN(currentScale)) currentScale = 0.15;
      
      let isPlaying = false;

      // Handle loading state
      window.addEventListener("load", () => {
        setTimeout(() => {
          document.getElementById("loading").style.display = "none";
        }, 1500);
      });

      // Register custom component to handle model loading errors
      AFRAME.registerComponent("model-loader", {
        init: function () {
          this.el.addEventListener("model-error", (e) => {
            console.error("Model load error:", e);
            alert("Gagal memuat model 3D. Pastikan URL benar.");
          });
          this.el.addEventListener("model-loaded", () => {
            console.log("Model loaded successfully");
            document.getElementById("loading").style.display = "none";
          });
        },
      });

      // Control functions
      function updateTransform() {
        const entity = document.getElementById("model");
        if (entity) {
            entity.object3D.scale.set(currentScale, currentScale, currentScale);
        }
      }
      
      function toggleAnimation() {
        const entity = document.getElementById("model");
        const btn = document.getElementById("btn-anim");
        const svg = btn.querySelector('svg');
        
        if (!entity) return;
        
        // Check if animation-mixer exists, if not add it
        if (!entity.getAttribute('animation-mixer')) {
           entity.setAttribute('animation-mixer', 'loop: repeat; timeScale: 0;');
           // We start paused (timeScale 0) effectively, or we can just not set it yet
        }

        isPlaying = !isPlaying;
        
        if (isPlaying) {
          entity.setAttribute('animation-mixer', 'timeScale: 1; loop: repeat;');
          btn.classList.add('active');
          // Change icon to Pause
          svg.innerHTML = '<rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect>';
        } else {
          entity.setAttribute('animation-mixer', 'timeScale: 0;');
          btn.classList.remove('active');
          // Change icon to Play
          svg.innerHTML = '<polygon points="5 3 19 12 5 21 5 3"></polygon>';
        }
      }

      function zoomIn() {
        currentScale *= 1.1; // Increase by 10%
        updateTransform();
      }

      function zoomOut() {
        currentScale *= 0.9; // Decrease by 10%
        updateTransform();
      }
      
      function toggleFullscreen() {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen().catch(err => {
            console.error(`Error attempting to enable fullscreen: ${err.message}`);
          });
        } else {
          if (document.exitFullscreen) {
            document.exitFullscreen();
          }
        }
      }
      
      // Listen for fullscreen change to update icon
      document.addEventListener('fullscreenchange', () => {
        const isFull = !!document.fullscreenElement;
        document.getElementById('icon-maximize').style.display = isFull ? 'none' : 'block';
        document.getElementById('icon-minimize').style.display = isFull ? 'block' : 'none';
      });
    </script>

    <a-scene
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
      renderer="logarithmicDepthBuffer: true; antialias: true; alpha: true; precision: medium;"
      vr-mode-ui="enabled: false"
    >
      <!-- Lighting -->
      <a-entity light="type: ambient; intensity: 1;"></a-entity>
      <a-entity
        light="type: directional; intensity: 1.5; position: 1 1 1"
      ></a-entity>

      <!-- Marker -->
      <a-marker
        preset="hiro"
        smooth="true"
        smoothCount="5"
        smoothTolerance="0.01"
        smoothThreshold="2"
      >
        <a-entity
          id="model"
          model-loader
          position="0 0 0"
          scale="0.15 0.15 0.15"
          rotation="0 0 0"
          animation-mixer="timeScale: 0;"
        ></a-entity>
      </a-marker>

      <a-entity camera></a-entity>
    </a-scene>

    <script>
      // Dynamically set model directly
      if (modelUrl) {
        const entity = document.getElementById("model");
        entity.setAttribute("gltf-model", modelUrl);
        // Initial set
        updateTransform();
      } else {
        // Only show alert if no model provided AND no postMessage expected (could be initial blank state)
        // alert("Tidak ada URL model yang diberikan.");
      }

      // Handle dynamic model switching via postMessage from React
      window.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'loadModel') {
          const { model, scale } = event.data;
          console.log("Received new model:", model, "scale:", scale);
          
          if (model) {
            const entity = document.getElementById("model");
            
            // 1. Reset animation first
            entity.setAttribute('animation-mixer', 'timeScale: 0');
            isPlaying = false;
            document.getElementById("btn-anim").classList.remove('active');
            document.getElementById("btn-anim").querySelector('svg').innerHTML = '<polygon points="5 3 19 12 5 21 5 3"></polygon>';

            // 2. Update model
            entity.setAttribute("gltf-model", model);
            
            // 3. Update scale if provided, otherwise keep current or default
            if (scale) {
              currentScale = parseFloat(scale);
            }
            updateTransform();
          }
        }
      });
    </script>
  </body>
</html>
