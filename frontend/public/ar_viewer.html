<!DOCTYPE html>
<html>
  <head>
    <title>AR Viewer</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <!-- AR.js for A-Frame -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <!-- A-Frame Extras for Animation Mixer -->
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.4.0/dist/aframe-extras.min.js"></script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family: sans-serif;
      }
      #loading {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      /* Control Panel Styles */
      #controls {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 12px;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.8);
        padding: 10px;
        border-radius: 20px;
        backdrop-filter: blur(5px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      }
      
      /* Fullscreen Button - Top Left */
      #fullscreen-btn {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 1000;
      }
      
      .btn {
        width: 44px;
        height: 44px;
        border: none;
        border-radius: 50%;
        background: white;
        color: #333;
        font-size: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.2s ease;
      }
      
      .btn:active {
        transform: scale(0.95);
        background: #f0f0f0;
      }
      
      .btn.active {
        background: #3498db;
        color: white;
      }
      
      .btn svg {
        width: 24px;
        height: 24px;
        fill: none;
        stroke: currentColor;
        stroke-width: 2;
        stroke-linecap: round;
        stroke-linejoin: round;
      }
    </style>
  </head>
  <body>
    <div id="loading">
      <div style="text-align: center">
        <div class="loader" style="margin: 0 auto 10px"></div>
        <div>Memuat AR...</div>
      </div>
    </div>

    <!-- UI Controls -->
    <div id="controls">
      <button class="btn" id="btn-zoom-out" onclick="zoomOut()">
        <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
      </button>
      <button class="btn" id="btn-zoom-in" onclick="zoomIn()">
        <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
      </button>
      <div style="width: 1px; background: #ccc; margin: 0 4px;"></div>
      <button class="btn" id="btn-anim" onclick="toggleAnimation()">
        <svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
      </button>
    </div>

    <a-scene
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
      vr-mode-ui="enabled: false"
      renderer="logarithmicDepthBuffer: true; precision: medium;"
    >
      <a-marker preset="hiro">
        <a-entity
          id="model"
          position="0 0 0"
          rotation="0 0 0"
          scale="0.15 0.15 0.15"
          animation-mixer="timeScale: 0"
          model-loader
        ></a-entity>
      </a-marker>
      <a-entity camera></a-entity>
    </a-scene>

    <script>
      // Parse query parameters
      const urlParams = new URLSearchParams(window.location.search);
      const modelUrl = urlParams.get("model");
      // Default to smaller scale (0.3) as requested
      let currentScale = parseFloat(urlParams.get("scale")) || 0.15;
      if (isNaN(currentScale)) currentScale = 0.15;
      
      let isPlaying = false;

      // Handle loading state
      window.addEventListener("load", () => {
        setTimeout(() => {
          document.getElementById("loading").style.display = "none";
        }, 1500);
      });

      // Register custom component to handle model loading errors
      AFRAME.registerComponent("model-loader", {
        init: function () {
          this.el.addEventListener("model-error", (e) => {
            console.error("Model load error:", e);
            alert("Gagal memuat model 3D. Pastikan URL benar.");
          });
          this.el.addEventListener("model-loaded", () => {
            console.log("Model loaded successfully");
            document.getElementById("loading").style.display = "none";
          });
        },
      });

      // Control functions
      function updateTransform() {
        const entity = document.getElementById("model");
        if (entity) {
            entity.object3D.scale.set(currentScale, currentScale, currentScale);
        }
      }
      
      // Function to replace the model entity completely
      function setModel(url, scale) {
        const marker = document.querySelector("a-marker");
        const oldEntity = document.getElementById("model");
        
        // Remove old entity if it exists
        if (oldEntity) {
          marker.removeChild(oldEntity);
        }
        
        // Create new entity
        const newEntity = document.createElement("a-entity");
        newEntity.setAttribute("id", "model");
        newEntity.setAttribute("position", "0 0 0");
        newEntity.setAttribute("rotation", "0 0 0");
        newEntity.setAttribute("scale", `${scale} ${scale} ${scale}`);
        newEntity.setAttribute("gltf-model", url);
        newEntity.setAttribute("animation-mixer", "timeScale: 0");
        newEntity.setAttribute("model-loader", ""); // Attach our error handler
        
        marker.appendChild(newEntity);
        
        // Reset UI
        isPlaying = false;
        const btn = document.getElementById("btn-anim");
        if (btn) {
            btn.classList.remove('active');
            const svg = btn.querySelector('svg');
            if (svg) svg.innerHTML = '<polygon points="5 3 19 12 5 21 5 3"></polygon>';
        }
        
        console.log("Model set to:", url);
      }

      window.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'loadModel') {
          const { model, scale } = event.data;
          console.log("Received new model:", model, "scale:", scale);
          
          if (model) {
            // Update current scale reference
            if (scale) {
              currentScale = parseFloat(scale);
            }
            setModel(model, currentScale);
          }
        }
      });

      // Initial Load
      if (modelUrl) {
         // We can use the existing one or replace it. 
         // Since the hardcoded one is in HTML, let's just use setModel to be consistent if we want, 
         // but the HTML one is fine for first load.
         // Actually, let's use the HTML one for first load, but ensure we update it if needed.
         const entity = document.getElementById("model");
         if(entity) {
            entity.setAttribute("gltf-model", modelUrl);
            updateTransform();
         }
      }
    </script>
  </body>
</html>
